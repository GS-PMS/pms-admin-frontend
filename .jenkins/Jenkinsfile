node {
    // Define environment variables
    env.DOCKER_HUB_REPO = 'salmawaleedd'
    env.SERVICE_NAME = 'pms-admin-frontend'
    env.IMAGE_TAG = "${BUILD_NUMBER}"
    env.COMPOSE_FILE = 'docker-compose-admin.yml'
    env.STACK_NAME = 'pms-admin'  // Stack name from docker-compose deployment
    env.COMPOSE_SERVICE_NAME = 'admin-frontend'  // Service name in docker-compose file
    env.HEALTH_CHECK_PORT = '4200'  // Health check port
    
    // This will hold the actual service name in Docker Swarm (with stack prefix)
    env.ACTUAL_SERVICE_NAME = "${env.STACK_NAME}_${env.COMPOSE_SERVICE_NAME}"
    
    try {
        // ============================================
        // STAGE 1: VALIDATE PUSH METHOD
        // ============================================
        stage('üö® Validate Push Method') {
            echo "=== Validating Git workflow ==="
            
            def isMerge = sh(
                script: "git rev-parse HEAD^2 >/dev/null 2>&1 && echo true || echo false",
                returnStdout: true
            ).trim()

            def committer = sh(
                script: "git log -1 --pretty=format:%cn",
                returnStdout: true
            ).trim()

            if (isMerge == "false") {
                error """
                ‚ùå‚ùå‚ùå DIRECT PUSH TO MAIN BLOCKED ‚ùå‚ùå‚ùå
                Commit ${env.GIT_COMMIT} by ${committer} is a direct commit to main.
                
                üìã REQUIRED WORKFLOW:
                1. Create feature branch: git checkout -b feature/your-feature
                2. Make changes and commit
                3. Create Pull Request to main
                4. Get code review approval
                5. Merge via PR (creates merge commit)
                """
            } else {
                echo "‚úÖ Merge commit detected ‚Äî committer: ${committer}"
                echo "‚úÖ PR workflow followed correctly"
            }
        }

        // ============================================
        // STAGE 2: ENVIRONMENT CHECK
        // ============================================
        stage('üîß Environment Check') {
            echo "=== Checking build environment ==="
            
            sh '''
                echo "üì¶ Required tools:"
                docker --version || { echo "‚ùå Docker not found"; exit 1; }
                docker-compose --version || { echo "‚ö†Ô∏è docker-compose not found"; }
                node --version || { echo "‚ùå Node.js not found"; exit 1; }
                npm --version || { echo "‚ùå npm not found"; exit 1; }
                git --version || { echo "‚ùå Git not found"; exit 1; }
                
                echo "‚úÖ All required tools available"
            '''
            
            echo "‚úÖ Environment check passed"
        }

        // ============================================
        // STAGE 3: CHECKOUT CODE
        // ============================================
        stage('üì• Checkout Code') {
            echo "=== Checking out ${SERVICE_NAME} ==="
            checkout scm
            
            echo "‚úÖ Repository: ${env.GIT_URL}"
            echo "‚úÖ Branch: ${env.GIT_BRANCH}"
            echo "‚úÖ Commit: ${env.GIT_COMMIT}"
        }

        // ============================================
        // STAGE 4: INSTALL DEPENDENCIES
        // ============================================
        stage('üì¶ Install Dependencies') {
            echo "=== Installing npm dependencies ==="
            
            sh 'npm ci'
            
            echo "‚úÖ Dependencies installed successfully"
        }

        // ============================================
        // STAGE 5: BUILD APPLICATION
        // ============================================
        stage('üèóÔ∏è Build Application') {
            echo "=== Building ${SERVICE_NAME} ==="
            
            sh 'npm run build'
            
            echo "‚úÖ Angular build completed"
        }

        // ============================================
        // STAGE 6: BUILD DOCKER IMAGE
        // ============================================
        stage('üê≥ Build Docker Image') {
            echo "=== Building Docker image ==="
            
            sh """
                docker build -t ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG} .
                docker tag ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG} ${DOCKER_HUB_REPO}/${SERVICE_NAME}:latest
            """
            
            echo "‚úÖ Docker image built successfully"
            echo "üì¶ Image: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG}"
            echo "üì¶ Also tagged as: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:latest"
        }

        // ============================================
        // STAGE 7: PUSH TO DOCKER HUB
        // ============================================
        stage('üì§ Push to Docker Hub') {
            echo "=== Pushing to Docker Hub ==="
            
            withCredentials([usernamePassword(
                credentialsId: 'dockerhub-credentials',
                usernameVariable: 'DOCKER_USER',
                passwordVariable: 'DOCKER_PASS'
            )]) {
                sh """
                    echo "üîê Logging in to Docker Hub as \${DOCKER_USER}"
                    echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                    
                    echo "üì§ Pushing image with build tag..."
                    docker push ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG}
                    
                    echo "üì§ Pushing 'latest' tag..."
                    docker push ${DOCKER_HUB_REPO}/${SERVICE_NAME}:latest
                """
            }
            
            echo "‚úÖ Images pushed to Docker Hub successfully"
        }

        // ============================================
        // STAGE 8: PREPARE DOCKER COMPOSE FILE
        // ============================================
        stage('üìã Prepare Docker Compose') {
            echo "=== Preparing Docker Compose file ==="
            
            // Check if docker-compose file exists
            def composeExists = sh(
                script: "test -f ${COMPOSE_FILE} && echo 'exists' || echo 'not-found'",
                returnStdout: true
            ).trim()
            
            if (composeExists == 'exists') {
                echo "‚úÖ Docker compose file exists: ${COMPOSE_FILE}"
                // Display current content
                sh "cat ${COMPOSE_FILE}"
                
                // Extract current port from compose file if available
                def currentPort = sh(
                    script: """
                        grep -oP 'ports:\\s*-\\s*\"\\K[0-9]+(?=:)' ${COMPOSE_FILE} | head -1 || echo '${HEALTH_CHECK_PORT}'
                    """,
                    returnStdout: true
                ).trim()
                
                if (currentPort && currentPort != HEALTH_CHECK_PORT) {
                    echo "‚ÑπÔ∏è  Using port from compose file: ${currentPort}"
                    env.HEALTH_CHECK_PORT = currentPort
                }
            } else {
                echo "üìù Creating docker-compose file..."
                sh """
                    cat > ${COMPOSE_FILE} << 'EOF'
                    version: '3.8'
                    services:
                      ${COMPOSE_SERVICE_NAME}:
                        image: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:latest
                        ports:
                          - "${HEALTH_CHECK_PORT}:80"
                        deploy:
                          replicas: 2
                          restart_policy:
                            condition: on-failure
                          update_config:
                            parallelism: 1
                            delay: 10s
                            order: start-first
                EOF
                """
                echo "‚úÖ Created ${COMPOSE_FILE}"
                sh "cat ${COMPOSE_FILE}"
            }
            
            // Update the image tag in the compose file to use the new build
            echo "üîÑ Updating image tag in compose file..."
            sh """
                sed -i "s|image:.*${SERVICE_NAME}.*|image: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG}|g" ${COMPOSE_FILE}
            """
            
            echo "üìã Updated compose file content:"
            sh "cat ${COMPOSE_FILE}"
            
            echo "‚úÖ Docker compose file prepared"
            echo "üîå Health check port: ${HEALTH_CHECK_PORT}"
        }

        // ============================================
        // STAGE 9: DEPLOY TO DOCKER SWARM
        // ============================================
        stage('üöÄ Deploy to Docker Swarm') {
            echo "=== Deploying to Docker Swarm ==="
            
            // 1. Initialize Swarm if needed
            def swarmStatus = sh(
                script: "docker info --format '{{.Swarm.LocalNodeState}}' 2>/dev/null || echo 'inactive'",
                returnStdout: true
            ).trim()
            
            if (swarmStatus != 'active') {
                echo "üîÑ Initializing Docker Swarm..."
                sh "docker swarm init --advertise-addr 127.0.0.1 2>/dev/null || true"
                sleep 3
                echo "‚úÖ Docker Swarm initialized"
            } else {
                echo "‚úÖ Docker Swarm is active"
            }
            
            // 2. Deploy/Update the stack
            echo "üì¶ Deploying stack: ${STACK_NAME}"
            
            withCredentials([usernamePassword(
                credentialsId: 'dockerhub-credentials',
                usernameVariable: 'DOCKER_USER',
                passwordVariable: 'DOCKER_PASS'
            )]) {
                sh """
                    echo "üîê Logging in to Docker Hub for registry auth"
                    echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                    
                    echo "üöÄ Deploying stack..."
                    docker stack deploy -c ${COMPOSE_FILE} ${STACK_NAME} --with-registry-auth
                    
                    echo "üö™ Logging out from Docker Hub"
                    docker logout
                """
            }
            
            echo "‚úÖ Stack deployment initiated"
            echo "üìä The service will be named: ${ACTUAL_SERVICE_NAME}"
            echo "üîå Service will be available on port: ${HEALTH_CHECK_PORT}"
        }

        // ============================================
        // STAGE 10: VERIFY DEPLOYMENT
        // ============================================
        stage('üîç Verify Deployment') {
            echo "=== Verifying deployment ==="
            
            // Wait a bit for containers to start
            sleep 10
            
            echo "üìã Checking stack status..."
            sh """
                echo "Stack: ${STACK_NAME}"
                docker stack ls
                echo ""
                echo "Services in stack:"
                docker stack services ${STACK_NAME}
                echo ""
                echo "Tasks (containers):"
                docker stack ps ${STACK_NAME}
            """
            
            // Check specific service
            echo "üîç Checking service: ${ACTUAL_SERVICE_NAME}"
            def serviceExists = sh(
                script: "docker service ls --filter name=${ACTUAL_SERVICE_NAME} --format '{{.Name}}' 2>/dev/null || echo ''",
                returnStdout: true
            ).trim()
            
            if (serviceExists) {
                echo "‚úÖ Service found: ${serviceExists}"
                
                // Get service details
                sh """
                    echo "üìä Service details:"
                    docker service inspect ${ACTUAL_SERVICE_NAME} --format '
Name:       {{.Spec.Name}}
Image:      {{.Spec.TaskTemplate.ContainerSpec.Image}}
Replicas:   {{.Spec.Mode.Replicated.Replicas}}
Ports:      {{range .Endpoint.Ports}}{{.PublishedPort}}->{{.TargetPort}} {{end}}
                    '
                    
                    echo ""
                    echo "üìà Current state:"
                    docker service ps ${ACTUAL_SERVICE_NAME} --format 'table {{.Name}}\\t{{.CurrentState}}\\t{{.Node}}' --no-trunc
                """
                
                // Get actual published port
                def actualPublishedPort = sh(
                    script: """
                        docker service inspect ${ACTUAL_SERVICE_NAME} \
                            --format '{{(index .Endpoint.Ports 0).PublishedPort}}' 2>/dev/null || echo '${HEALTH_CHECK_PORT}'
                    """,
                    returnStdout: true
                ).trim()
                
                if (actualPublishedPort != HEALTH_CHECK_PORT) {
                    echo "‚ÑπÔ∏è  Actual published port is: ${actualPublishedPort}"
                    env.HEALTH_CHECK_PORT = actualPublishedPort
                }
            } else {
                echo "‚ö†Ô∏è  Service not found with exact name, listing all services..."
                sh "docker service ls --format 'table {{.Name}}\\t{{.Image}}\\t{{.Replicas}}'"
                
                // Try to find service with similar name
                def similarService = sh(
                    script: "docker service ls --format '{{.Name}}' | grep -i 'admin\\|frontend' | head -1 || echo ''",
                    returnStdout: true
                ).trim()
                
                if (similarService) {
                    echo "‚ÑπÔ∏è  Found similar service: ${similarService}"
                    env.ACTUAL_SERVICE_NAME = similarService
                }
            }
            
            echo "‚úÖ Verification completed"
            echo "üîå Health check port: ${HEALTH_CHECK_PORT}"
        }

        // ============================================
        // STAGE 11: HEALTH CHECK
        // ============================================
        stage('üè• Health Check') {
            echo "=== Performing health check ==="
            echo "üîå Testing service on port: ${HEALTH_CHECK_PORT}"
            
            def healthCheckPassed = false
            def maxAttempts = 10
            
            for (int attempt = 1; attempt <= maxAttempts; attempt++) {
                echo "ü©∫ Health check attempt ${attempt}/${maxAttempts}"
                
                try {
                    def statusCode = sh(
                        script: """
                            curl -s -o /dev/null -w '%{http_code}' \
                                --max-time 10 \
                                http://localhost:${HEALTH_CHECK_PORT} || echo '000'
                        """,
                        returnStdout: true
                    ).trim()
                    
                    if (statusCode == '200' || statusCode.startsWith('2')) {
                        echo "‚úÖ Health check PASSED (HTTP ${statusCode})"
                        healthCheckPassed = true
                        break
                    } else {
                        echo "‚è≥ Got HTTP ${statusCode}, retrying in 5s..."
                    }
                } catch (Exception e) {
                    echo "‚è≥ Connection failed, retrying in 5s..."
                }
                
                sleep 5
            }
            
            if (healthCheckPassed) {
                echo "‚úÖ Service is healthy and responding on port ${HEALTH_CHECK_PORT}"
            } else {
                echo "‚ö†Ô∏è  Health check failed or inconclusive on port ${HEALTH_CHECK_PORT}"
                echo "üìã Checking container logs..."
                sh """
                    docker service logs ${ACTUAL_SERVICE_NAME} --tail 10 2>/dev/null || echo "Could not retrieve logs"
                """
                // Don't fail the pipeline for health check
                echo "‚ö†Ô∏è  Manual verification required at http://localhost:${HEALTH_CHECK_PORT}"
            }
        }

        // ============================================
        // STAGE 12: FINAL STATUS
        // ============================================
        stage('üìä Final Status') {
            echo "=== Deployment Summary ==="
            
            // Get final service details
            sh """
                echo "üéØ DEPLOYMENT COMPLETE"
                echo ""
                echo "üìã Stack: ${STACK_NAME}"
                echo "üê≥ Service: ${ACTUAL_SERVICE_NAME}"
                echo "üì¶ Image: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG}"
                echo "üî¢ Build: ${IMAGE_TAG}"
                echo "üîå Port: ${HEALTH_CHECK_PORT}"
                echo ""
                echo "üìä Current status:"
                docker service ls --filter name=${ACTUAL_SERVICE_NAME} --format 'table {{.Name}}\\t{{.Image}}\\t{{.Replicas}}\\t{{.Ports}}'
                echo ""
                echo "üêã Running containers:"
                docker service ps ${ACTUAL_SERVICE_NAME} --format 'table {{.Name}}\\t{{.CurrentState}}\\t{{.Node}}' --filter 'desired-state=running'
            """
            
            echo "‚úÖ Pipeline completed successfully!"
            echo "üåê Application URL: http://localhost:${HEALTH_CHECK_PORT}"
        }
        
    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        echo "‚ùå Pipeline failed with error: ${e.message}"
        echo "üîç Stack trace: ${e.getStackTrace().join('\n')}"
        throw e
    } finally {
        // ============================================
        // CLEANUP
        // ============================================
        echo "=== Final cleanup ==="
        sh '''
            echo "üßπ Cleaning up Docker resources..."
            docker logout 2>/dev/null || true
            echo "‚úÖ Cleanup completed"
        '''
        
        if (currentBuild.result == 'SUCCESS') {
            echo """
            üéâüéâüéâ DEPLOYMENT SUCCESSFUL! üéâüéâüéâ
            
            Your application has been deployed to Docker Swarm.
            
            üåê Access it at: http://localhost:${HEALTH_CHECK_PORT}
            
            üìä Service details:
            ‚Ä¢ Stack: ${STACK_NAME}
            ‚Ä¢ Service: ${ACTUAL_SERVICE_NAME}
            ‚Ä¢ Image: ${DOCKER_HUB_REPO}/${SERVICE_NAME}:${IMAGE_TAG}
            ‚Ä¢ Port: ${HEALTH_CHECK_PORT}
            
            üîß Management commands:
            ‚Ä¢ View logs: docker service logs ${ACTUAL_SERVICE_NAME} -f
            ‚Ä¢ Check status: docker service ps ${ACTUAL_SERVICE_NAME}
            ‚Ä¢ List all services: docker service ls
            ‚Ä¢ Remove stack: docker stack rm ${STACK_NAME}
            ‚Ä¢ Scale service: docker service scale ${ACTUAL_SERVICE_NAME}=3
            """
        } else {
            echo """
            ‚ùå‚ùå‚ùå DEPLOYMENT FAILED ‚ùå‚ùå‚ùå
            
            üîç Troubleshooting steps:
            1. Check Docker Swarm status: docker node ls
            2. Check services: docker service ls
            3. Check specific service: docker service ps ${ACTUAL_SERVICE_NAME}
            4. Check logs: docker service logs ${ACTUAL_SERVICE_NAME}
            5. Verify Docker Hub credentials
            6. Check port ${HEALTH_CHECK_PORT} availability
            
            üõ†Ô∏è  Recovery options:
            ‚Ä¢ Manually deploy: docker stack deploy -c ${COMPOSE_FILE} ${STACK_NAME}
            ‚Ä¢ Check compose file: cat ${COMPOSE_FILE}
            ‚Ä¢ Verify Docker image exists: docker image ls | grep ${SERVICE_NAME}
            """
        }
    }
}
