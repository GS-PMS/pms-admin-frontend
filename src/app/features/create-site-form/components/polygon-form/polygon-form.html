<div class="polygon-form" [formGroup]="polygonGroup()" [id]="polygonIndex()">
  <div class="polygon-form__header">
    <h4 class="polygon-form__title">Polygon {{ polygonIndex() + 1 }}</h4>
    @if (canRemove()) {
    <button
      type="button"
      class="polygon-form__btn polygon-form__btn--danger polygon-form__btn--sm"
      (click)="onRemove()"
      [id]="'remove-btn-' + polygonIndex()"
    >
      Remove
    </button>
    }
  </div>

  <div class="polygon-form__field">
    <label class="polygon-form__label" [for]="'polygonName-' + polygonIndex()"
      >Polygon Name <span class="polygon-form__required">*</span></label
    >
    <input
      type="text"
      formControlName="name"
      class="polygon-form__input"
      [class.polygon-form__input--error]="isFieldInvalid('name')"
      placeholder="Enter polygon name (e.g., Zone A)"
      [id]="'polygonName-' + polygonIndex()"
    />
    @if (isFieldInvalid('name')) {
    <span class="polygon-form__error" [id]="'polygonName-error' + polygonIndex()">
      @if (polygonGroup().get('name')?.errors?.['required'] ||
      polygonGroup().get('name')?.errors?.['whitespaceOnly']) { Polygon name is required. } @else if
      (polygonGroup().get('name')?.errors?.['minlength'] ||
      polygonGroup().get('name')?.errors?.['maxlength']) { Polygon name must be between 3 and 100
      characters. }
    </span>
    }
  </div>

  <div class="coordinates">
    <div class="coordinates__header">
      <label class="polygon-form__label"
        >Coordinates (min 3) <span class="polygon-form__required">*</span></label
      >
      <button
        type="button"
        class="polygon-form__btn polygon-form__btn--outline polygon-form__btn--sm"
        (click)="addCoordinate()"
        [id]="'point-btn-' + polygonIndex()"
      >
        Add Point
      </button>
    </div>

    @if (hasCoordinatesError() && coordinates.errors?.['minlength']) {
    <span class="polygon-form__error">At least 3 coordinates are required per polygon.</span>
    } @if (hasDuplicateCoordinatesError()) {
    <span class="polygon-form__error">Duplicate coordinates are not allowed.</span>
    }

    <div class="coordinates__list" formArrayName="coordinates">
      @for (coord of coordinates.controls; track $index; let cooId = $index) {
      <div
        class="coordinates__row"
        [formGroupName]="cooId"
        [class.coordinates__row--duplicate]="isCoordinateDuplicate(cooId)"
        [id]="'polygon-' + polygonIndex() + '-row-' + cooId"
      >
        <span class="coordinates__index">{{ cooId + 1 }}.</span>

        <div class="coordinates__field">
          <input
            type="number"
            formControlName="latitude"
            class="polygon-form__input polygon-form__input--sm"
            [class.polygon-form__input--error]="isCoordinateFieldInvalid(cooId, 'latitude')"
            placeholder="Latitude"
            step="any"
            [id]="'polygon-' + polygonIndex() + '-lat-' + cooId"
          />
          @if (isCoordinateFieldInvalid(cooId, 'latitude')) {
          <span
            class="polygon-form__error polygon-form__error--inline"
            [id]="'polygon-' + polygonIndex() + '-lat-' + cooId + '-error'"
          >
            @if (coordinates.at(cooId).get('latitude')?.errors?.['required']) { Required } @else if
            (coordinates.at(cooId).get('latitude')?.errors?.['latitude']) { Invalid (-90 to 90) }
            @else if (coordinates.at(cooId).get('latitude')?.errors?.['maxDecimals']) { Max 6
            decimals }
          </span>
          }
        </div>

        <div class="coordinates__field">
          <input
            type="number"
            formControlName="longitude"
            class="polygon-form__input polygon-form__input--sm"
            [class.polygon-form__input--error]="isCoordinateFieldInvalid(cooId, 'longitude')"
            placeholder="Longitude"
            step="any"
            [id]="'polygon-' + polygonIndex() + '-lng-' + cooId"
          />
          @if (isCoordinateFieldInvalid(cooId, 'longitude')) {
          <span
            class="polygon-form__error polygon-form__error--inline"
            [id]="'polygon-' + polygonIndex() + '-lng-' + cooId + '-error'"
          >
            @if (coordinates.at(cooId).get('longitude')?.errors?.['required']) { Required } @else if
            (coordinates.at(cooId).get('longitude')?.errors?.['longitude']) { Invalid (-180 to 180)
            } @else if (coordinates.at(cooId).get('longitude')?.errors?.['maxDecimals']) { Max 6
            decimals }
          </span>
          }
        </div>

        @if (coordinates.length > 3) {
        <button
          type="button"
          class="polygon-form__btn polygon-form__btn--icon polygon-form__btn--danger"
          (click)="removeCoordinate(cooId)"
        >
          Ã—
        </button>
        }
      </div>
      }
    </div>
  </div>
</div>
